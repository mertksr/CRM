<?php
include 'connect.php';

if (!empty($_POST)) {
    $num_of_digits = 6;
    $number = str_pad(mt_rand(1, pow(10, $num_of_digits) - 1), $num_of_digits, '0', STR_PAD_LEFT);

    $adsoyad = $_POST["adsoyad"];
    $tel1 = $_POST["tel1"];
    $tel2 = $_POST["tel2"];
    $bolge = $_POST["bolge"];
    $konum = $_POST["konum"];
    $adres = $_POST["adres"];
    $vergino = $_POST["vergino"];
    $unvan = $_POST["unvan"];
    

    if ($_POST["mMusteriNo"] != '') {
        $query = "UPDATE musteriler SET mAdSoyad=:adsoyad WHERE mMusteriNo=:id";
        $statement = $db->prepare($query);
        $statement->bindParam(':name', $name);
        $statement->bindParam(':id', $_POST["mMusteriNo"]);
        $message = 'Data Updated';
    } else {
        $query = "INSERT INTO musteriler(mMusteriNo,mAdSoyad,mTel1,mTel2,mBolge,mKonum,mAdres.mVergiNo,mUnvan) VALUES(:number,:adsoyad,:tel1,:tel2,:bolge,:konum,:adres,:vergi,:unvan)";
        $statement = $db->prepare($query);
        $statement->bindParam(':number', $number);
        $statement->bindParam(':name', $name);
        $statement->bindParam(':tel1', $tel1);
        $statement->bindParam(':tel2', $tel2);
        $statement->bindParam(':bolge', $bolge);
        $statement->bindParam(':konum', $konum);
        $statement->bindParam(':adres', $adres);
        $statement->bindParam(':vergino', $vergino);
        $statement->bindParam(':unvan', $unvan);
        $message = 'Data Inserted';
    }

    if ($statement->execute()) {
        $output = '<label class="text-success">' . $message . '</label>';
        $select_query = "SELECT * FROM musteriler";
        $result = $db->query($select_query);
        $output .= '<table class="table table-bordered">';
        $output .= ' <table id="musteriler" class="table dt-table-hover" style="width:100%">
        <thead>
            <tr>


                <th style="max-width:50px;"><input type="text" class="form-control" id="specialsearch" placeholder="Ad Soyad"></th>

                <th style="max-width:30px;"><input type="text" class="form-control" id="specialsearch" placeholder="Bölge"></th>
                <th style="max-width:10px;text-align:center;">Önceki Bakım</th>
                <th style="max-width:10px;text-align:center;"><input type="text" class="form-control" id="specialsearch" placeholder="Bakım"></th>
                <th style="max-width:10px;text-align:center;"><input type="text" class="form-control" id="specialsearch" placeholder="Sonraki Bakım"></th>
                <th style="max-width:20px;text-align:center;">İletişim</th>
                <th style="max-width:20px;text-align:center;">Randevu</th>
                <th style="max-width:20px;text-align:center;">Düzenle</th>

                <th style="max-width:20px;text-align:center;">İşlemler</th>

            </tr>
        </thead>
        <tbody>';
        while ($row = $result->fetch(PDO::FETCH_ASSOC)) {
            $output .=                                      
            $musterisor = $db->prepare("SELECT * from musteriler");
            $musterisor->execute();
            $say = 0;
            while ($mustericek = $musterisor->fetch(PDO::FETCH_ASSOC)) { 
                $say++;
                $tarih = $mustericek['mSonIslem'];
                $yeni_tarih = date('d.m.Y', strtotime($tarih . '+' . $mustericek['mPeriyot'] . ' months'));
                $musterino =  $mustericek["mMusteriNo"];
                $modalId = "modal" . $mustericek["mMusteriNo"];
                $mahalle = $mustericek['mBolge'];
                $mahallesor = $db->prepare("SELECT * from neighborhood where NeighborhoodID =  $mahalle");
                $mahallesor->execute();
                $mahallecek = $mahallesor->fetch(PDO::FETCH_ASSOC);

                $query = "SELECT * FROM islemler WHERE islemMusteriNo = :customer_id ORDER BY islemTarihi DESC LIMIT 1";
                $islemsor = $db->prepare($query);
                $islemsor->bindParam(':customer_id', $mustericek['mMusteriNo']);


                $islemsor->execute();
                $count = $islemsor->rowCount();

                $islemcek = $islemsor->fetch(PDO::FETCH_ASSOC);
                $tarih = date('d.m.Y', strtotime($islemcek['islemTarihi']));
                $sonrakibakim = date('Y-m-d', strtotime('+' . $islemcek['islemPeriyot'] . ' months'));
                setlocale(LC_TIME, "tr_TR"); // Türkçe yerel ayarlarını kullan

                $sonrakibakim =  strftime("%B %Y", strtotime("$sonrakibakim"));
                $sonrakibakim = iconv('ISO-8859-9', 'UTF-8', $sonrakibakim);

            


              '  <tr>

                    <td style="text-transform:uppercase;">'. $mustericek['mAdSoyad'].'</td>
                    <td>'. $mahallecek['NeighborhoodName'] .'</td>

                    <td style="text-align:center;">'.$tarih.'</td>
                    <td style="text-align:center;text-transform:uppercase;">'.$islemcek['islemPeriyot'] . ' Ay                                                                       
                    </td>
                    <td style="text-align:center;text-transform:uppercase;">'.$sonrakibakim.'</td>

                    <td style="max-width:20px;">
                        <div class="text-center">
                            <button type="button" name="detay" value="detay" data-adsoyad="'. $mustericek['mAdSoyad'].'" id="'. $mustericek["mMusteriNo"] .'" class="btn btn-ozel mr-2 detay">
                                <i class="fa-solid fa-address-book"></i>
                            </button>
                        </div>

                    </td>




                    <td style="max-width:20px;">
                        <div class="text-center">
                            <button type="button" class="btn special1 mr-2" style="color:#EFF5F5;" data-bs-toggle="modal" data-bs-target="#randevu'. $modalId .'">
                                <i class="fa-solid fa-calendar-plus"></i>
                            </button>
                        </div>
                        <!-- Modal -->
                        <div class="modal fade" id="randevu'. $modalId .'" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">

                                        <h4 class="modal-title" id="exampleModalLabel" style="color:#E21818; margin:auto;text-transform:uppercase;">'. $mustericek['mAdSoyad'].'</h4>

                                        <button type="button" class="btn-close" style="margin:0;" data-bs-dismiss="modal" aria-label="Close"></button>

                                    </div>
                                    <div class="modal-body row">

                                        <form id="formRandevu-<?= $say; ?>" method="POST">
                                            <div class="row g-1">

                                                <div class="col-6">
                                                    <label for="defaultInputState" class="form-label ">Hizmet Türü</label>
                                                    <select id="defaultInputState" form="formRandevu-'.$say.'" name="hizmetturu" class="form-select">
                                                        <option selected="">Seç</option>';
                                                     

                                                        $hizmetsor = $db->prepare("SELECT * FROM hizmetler");
                                                        $hizmetsor->execute();
                                                        while ($hizmetcek = $hizmetsor->fetch(PDO::FETCH_ASSOC)) {
                                                            if ($hizmetcek['hNo'] == 1 || $hizmetcek['hNo'] == 2) {


                                                        
                                                             $output .=  '  <option value="'.$hizmetcek['HizmetTuru'].'">'. $hizmetcek['HizmetTuru'] .'</option> ';

                                                       } } 
                                                       $output .= '
                                                    </select>
                                                </div>

                                                <div class="col-6">
                                                    <label for="defaultInputState" class="form-label ">Teknisyen</label>
                                                    <select id="defaultInputState" form="formRandevu-'.$say.'" name="teknisyen" class="form-select">
                                                        <option selected="">Seç</option>
                                                        <option value="Bedirhan">Bedirhan</option>
                                                        <option value="Cihan">Cihan</option>
                                                        <option value="Mehmet">Mehmet</option>
                                                    </select>
                                                </div>
                                                <div class="form-group col-12">
                                                    <label for="exampleFormControlInput1">Notlar</label>
                                                    <input type="text" form="formRandevu-'. $say.'" name="notlar" style="text-transform:uppercase;" class="form-control">

                                                </div>
                                                <input type="hidden" name="musterino" form="formRandevu-'.$say.'" value="'. $mustericek['mMusteriNo'].'">

                                                <input type="hidden" id="modalid" name="modalid" form="formRandevu-'.$say.'" value="'. $modalId.'">

                                            </div>


                                    </div>

                                    <div class="modal-footer">
                                        <button type="submit" form="formRandevu-'.$say.'" class="btn btn-success" style="color:#EFF5F5;">Kaydet</button>


                                    </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                    </td>

                    <td style="max-width:20px;">
                        <div class="text-center">
                            <button type="button" class="btn btn-ozel mr-2" data-bs-toggle="modal" onclick="openModal()" data-bs-target="#duzenle'.$modalId.'">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                        </div>

                    </td>

                    <td style="text-align:center;">
                        <div class="btn-group">
                            <a class="btn btn-dark btn-sm btn-ozel" href="musteridetay.php?no='. $mustericek['mMusteriNo'].'">Düzenle</a>
                            <button type="button" class="btn btn-dark btn-sm dropdown-toggle dropdown-toggle-split btn-ozel" id="dropdownMenuReference2" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-reference="parent">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuReference2">
                                <a class="dropdown-item" href="islemler.php?no='.$mustericek['mMusteriNo'].'">Servis Kayıtları</a>
                                <a class="dropdown-item" href="mrandevular.php?no='. $mustericek['mMusteriNo'].'">Randevular</a>
                                <a class="dropdown-item" href="satislar.php?no='. $mustericek['mMusteriNo'].'">Satışlar</a> ';


                                 if ($mustericek['mKonum'] != "") {
                                   $output.= ' <a class="dropdown-item" target="_Blank" href="https://maps.google.com/?q= ' . $mustericek["mKonum"] . ' ">Konum Aç</a> ';
                                } 
                                $output.= ' <a class="dropdown-item" href="#">Ertele</a>

                            </div>
                        </div>
                    </td>
                </tr>


             '; } } 

        
        $output .= '                                    
        </tbody>
        </table>';
        echo $output;
    }
}
